<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
    namespace="com.fastretailing.dcp.sales.common.repository.optional.SalesTransactionHistoryDetailOptionalMapper">
    <resultMap id="BaseResultMap"
        type="com.fastretailing.dcp.sales.common.entity.optional.SalesTransactionHistoryDetail">
        <!-- WARNING - @mbg.generated This element is automatically generated by 
            MyBatis Generator, do not modify. -->
        <id column="system_brand_code" jdbcType="VARCHAR" property="systemBrandCode" />
        <id column="system_country_code" jdbcType="VARCHAR" property="systemCountryCode" />
        <id column="view_store_code" jdbcType="VARCHAR" property="viewStoreCode" />
        <result column="store_name" jdbcType="VARCHAR" property="storeName" />
        <result column="cash_register_no" jdbcType="VARCHAR" property="cashRegisterNo" />
        <result column="receipt_no" jdbcType="VARCHAR" property="receiptNo" />
        <result column="sales_transaction_type" jdbcType="VARCHAR"
            property="salesTransactionType" />
        <result column="data_creation_date_time" jdbcType="TIMESTAMP"
            property="dataCreationDateTime" typeHandler="com.fastretailing.dcp.storecommon.typehandler.OffsetDatetimeTypeHandler"/>
        <result column="order_status_update_date" jdbcType="VARCHAR"
            property="orderStatusUpdateDate" />
        <result column="error_type" jdbcType="VARCHAR" property="errorType" />
        <result column="data_alteration_user_id" jdbcType="VARCHAR"
            property="dataAlterationUserId" />
        <result column="update_datetime" jdbcType="TIMESTAMP" property="updateDateTime" />
        <result column="data_alteration_sales_linkage_type" jdbcType="NUMERIC"
            property="dataAlterationSalesLinkageType" />
        <result column="data_alteration_backbone_linkage_type"
            jdbcType="NUMERIC" property="dataAlterationBackboneLinkageType" />
        <result column="update_type" jdbcType="VARCHAR" property="updateType" />
        <result column="history_type" jdbcType="VARCHAR" property="historyType" />
        <result column="sales_transaction_error_id" jdbcType="VARCHAR" property="salesTransactionErrorId" />
    </resultMap>
    <select id="selectSalesTransactionHistoryDetailByCondition"
        parameterType="com.fastretailing.dcp.sales.common.entity.optional.SalesTransactionHistoryDetailCondition"
        resultMap="BaseResultMap">
        select /* SalesTransactionHistoryDetailOptionalMapper-001 */
          t01.sales_transaction_error_id
          , t01.system_brand_code
          , t01.system_country_code
          , t01.error_type
          , t01.update_datetime
          , t02.transaction_id
          , t02.data_alteration_user_id
          , t02.data_alteration_sales_linkage_type
          , t02.data_alteration_backbone_linkage_type
          , t02.update_type
          , t02.history_type 
          , t03.cash_register_no
          , t03.receipt_no
          , t03.sales_transaction_type
          , t03.data_creation_date_time
          , t03.order_status_update_date
          , t04.store_code
          , t04.view_store_code
          , t04.store_name
        from
          ( 
            select
              sales_transaction_error_id
              , system_brand_code
              , system_country_code
              , error_type
              , update_datetime 
              , store_code 
            from
              t_sales_transaction_error_detail t01 
            where
              t01.system_brand_code = #{systemBrandCode}
              and t01.system_country_code = #{systemCountryCode}
              <if test="updateDatetimeFrom != null">
                <![CDATA[
                  and t01.update_datetime >= #{updateDatetimeFrom}
                ]]> 
                </if>
                <if test="updateDatetimeTo != null">
                <![CDATA[
                  and t01.update_datetime <= #{updateDatetimeTo}
                ]]> 
              </if>
              <if test="errorType != null and errorType != ''"> 
                and t01.error_type = #{errorType}
              </if>
              and t01.data_alteration_status_type = #{dataAlterationStatusType}
          ) t01 
          left outer join t_alteration_history_order_information t02 
            on t02.sales_transaction_error_id = t01.sales_transaction_error_id 
            and t02.history_type = #{orderHistoryType} 
            <if test="dataAlterationUserId != null and dataAlterationUserId != ''"> 
              and t02.data_alteration_user_id = #{dataAlterationUserId}
            </if>
          left outer join t_alteration_history_sales_transaction_header t03 
            on t03.sales_transaction_error_id = t01.sales_transaction_error_id 
            and t03.history_type = #{headerHistoryType}
            <if test="dataCreationDateTimeFrom != null">
                <![CDATA[
                  and t03.data_creation_date_time >= #{dataCreationDateTimeFrom} 
                ]]> 
                </if>
                <if test="dataCreationDateTimeTo != null">
                <![CDATA[
                  and t03.data_creation_date_time <= #{dataCreationDateTimeTo}
                ]]> 
            </if>
            <if test="cashRegisterNo != null">
              and t03.cash_register_no = #{cashRegisterNo} 
            </if>
            <if test="receiptNo != null and receiptNo != ''">
              and t03.receipt_no = #{receiptNo} 
            </if>
            and t03.sales_linkage_type = #{salesLinkageType} 
            <if test="salesTransactionType != null and salesTransactionType != ''">
              and t03.sales_transaction_type = #{salesTransactionType}
            </if>
            <if test="orderStatusUpdateDateFrom != null and orderStatusUpdateDateFrom != ''">
                <![CDATA[
                  and t03.order_status_update_date >= #{orderStatusUpdateDateFrom} 
                ]]> 
                </if>
                <if test="orderStatusUpdateDateTo != null and orderStatusUpdateDateTo != ''">
                <![CDATA[
                  and t03.order_status_update_date <= #{orderStatusUpdateDateTo}
                ]]> 
            </if>
          left outer join m_trans_store_code t04 
            on t04.store_code = t01.store_code 
            and t04.view_store_code = #{viewStoreCode} 
        where
          t02.transaction_id is not null 
          and t03.transaction_id is not null 
          and t04.store_code is not null 
        order by
          t03.cash_register_no asc
          , t03.receipt_no asc
    </select>
    <select id="selectErrorContentsName"
		parameterType="com.fastretailing.dcp.sales.common.entity.optional.SalesTransactionHistoryDetail"
		resultType="java.lang.String">
		SELECT  /* SalesTransactionHistoryDetailOptionalMapper-002 */
		name_1
		FROM
		m_common_code_master
		WHERE
		type_value = #{errorType}
		and type_id = 'error_type'
	</select>
</mapper>